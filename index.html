<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Papeletas - Cirineo</title>

    <!-- Icono -->
<link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">

    <!-- Librerías Externas (React, Firebase, Tailwind, Lucide, JsBarcode) -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Fuentes para la etiqueta -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

<style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        /* ESTILOS GENERALES DE LA APP */
        body { background-color: #f1f5f9; height: 100vh; overflow: hidden; font-family: 'Roboto Condensed', sans-serif; }

        body { font-family: 'Roboto', sans-serif; }
        /* ESTILOS DE LA ETIQUETA (LABEL) */
        .label-preview-container {
            width: 6in;
            height: 4in;
            background-color: white;
            position: relative;
            box-sizing: border-box;
            border: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 15px -2px rgba(0, 0, 0, 0.1); /* Sombra más sutil para múltiples etiquetas */
            transition: transform 0.2s;
        }

        /* Estilos internos de la etiqueta (Copiados del diseño anterior) */
        .lbl-row { display: flex; border-bottom: 2px solid #000; width: 100%; }
        .lbl-row:last-child { border-bottom: none; }
        .lbl-col { border-right: 2px solid #000; padding: 4px 8px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .lbl-col:last-child { border-right: none; }
        .lbl-title { font-size: 14px; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1; margin-bottom: 2px; }
        .lbl-big { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 42px; line-height: 0.9; color: #000; white-space: nowrap; }
        .lbl-medium { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 26px; line-height: 1; color: #000; white-space: nowrap; }
        .lbl-small { font-size: 16px; font-weight: 700; color: #000; }

        /* Estilos de impresión */
        /* Ajustes específicos para filas de la etiqueta */
        .row-header { height: 18%; }
        .row-info { height: 12%; }
        .row-desc { height: 10%; align-items: center; }
        .row-metrics { height: 22%; }
        .row-details { height: 23%; }
        .row-footer { height: 15%; }

        /* ESTILOS DE IMPRESIÓN */
@media print {
            body { 
                background: none; 
                margin: 0; 
                padding: 0;
            }
            /* Definir el tamaño de la página */
            @page { size: 6in 4in; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; }
.no-print { display: none !important; }
            .print-container { 
                padding: 0 !important; 
                margin: 0 !important; 
                box-shadow: none !important;
                background: none !important;
                overflow: visible !important;

            /* Contenedor principal para impresión, oculta elementos de la pantalla */
            .print-container {
                display: block; /* Muestra el contenedor de impresión */
                overflow: visible !important; /* Permite que los elementos se impriman fuera de la vista de pantalla */
                width: auto;
                height: auto;
                padding: 0;
                margin: 0;
}

            /* Cada etiqueta debe forzar un salto de página después de sí misma */
.label-wrapper {
                page-break-after: always;
                box-shadow: none !important;
                margin-bottom: 0 !important;
                margin: 0 !important;
padding: 0 !important;
                width: 6in;
                height: 4in;
                page-break-after: always; /* Salto de página después de cada etiqueta */
                box-shadow: none !important;
}

            /* La última etiqueta no debe tener salto de página */
.label-wrapper:last-child {
page-break-after: avoid;
}
            .papeleta {
                border: 1px solid #000;
                margin: 0;
            }

            .label-preview-container { border: none; transform: none !important; box-shadow: none; margin: 0; }
}
    </style>

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50">
<body>
<div id="root"></div>

<script type="text/babel">
        // Acceder a las funciones de React
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuración de Firebase ---
        // --- CONFIGURACIÓN DE FIREBASE ---
        // Utiliza variables globales si están disponibles, sino usa la configuración estática
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
            apiKey: "TU_API_KEY", // Reemplaza con tu API Key
            authDomain: "TU_AUTH_DOMAIN", // Reemplaza con tu dominio
            projectId: "TU_PROJECT_ID", // Reemplaza con tu Project ID
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
};

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        // Inicialización de Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

        // --- Componentes de Interfaz y Lógica ---
        // --- COMPONENTE ICONO (FIXED: Usa useRef y useEffect para inyectar SVG directamente) ---
        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);

        // Iconos de Lucide
        const Icon = ({ name, size = 24, className = "" }) => {
            const [iconHtml, setIconHtml] = useState(null);
            
useEffect(() => {
                const iconFn = lucide.icons[name];
                if (iconFn) {
                    const attributes = {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = ''; 
                    const svgString = lucide.icons[name].toSvg({
width: size,
height: size,
                        class: className,
                        stroke: "currentColor",
                        strokeWidth: "2",
                        strokeLinecap: "round",
                        strokeLinejoin: "round",
                    };
                    setIconHtml(iconFn(attributes));
                        class: className
                    });
                    containerRef.current.innerHTML = svgString;
}
}, [name, size, className]);

            if (!iconHtml) return null;
            return <div dangerouslySetInnerHTML={{ __html: iconHtml }} />;
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
};

        // Componente de Etiqueta de Producción (Papeleta)
        // --- COMPONENTE DE ETIQUETA (VISUAL) ---
        // Ahora acepta 'labelData' que incluye información específica del paquete
const ProductionLabel = ({ labelData }) => {
const svgRef = useRef(null);

            const order = labelData;
            const pkgInfo = order.pkgInfo || {};

            // ************ CORRECCIÓN CLAVE ************
            // El Santoni.html espera el formato ORDER_ID-PACKAGE_ID
            // Aseguramos que la orden tenga su ID (order.id) y el ID de paquete (order.pkgId)
            const barcodeValue = `${order.id}-${order.pkgId}`;
            // *******************************************

            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                // Asumiendo que el timestamp es un objeto de Firebase Firestore
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('es-MX', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            };
            // Datos de la orden base
            const order = labelData; 
            const subPiece = order.subPiecesData && order.subPiecesData.length > 0 ? order.subPiecesData[0] : {};
            
            // Lógica de hilos (se mantiene)
            const materialNylon = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('NYLON')) : null;
            const materialLycra = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('LYCRA')) : null;
            const lycraText = materialLycra ? materialLycra.material.replace(/LYCRA/i, '').trim() : (order.threading && order.threading[1] ? order.threading[1].material : 'N/A');
            const nylonText = materialNylon ? materialNylon.material.replace(/NYLON/i, '').trim() : (order.threading && order.threading[0] ? order.threading[0].material : 'N/A');
            
            // Datos específicos del paquete (nuevos campos)
            const currentPackageDisplay = order.displayPackageId || '1/1'; // e.g., 1/6
            const piecesInPackage = order.piecesInPackage || (order.packageSize === 'VARIO' ? 'VAR' : (order.packageSize || 50));
            const barcodeValue = order.packageCode || `${order.partida}-${order.codigo}`; // e.g., DIC25_02-M024-1-6

            // Generar Código de Barras cuando cambie la orden
useEffect(() => {
if (svgRef.current && barcodeValue) {
try {
JsBarcode(svgRef.current, barcodeValue, {
format: "CODE128",
lineColor: "#000",
width: 2,
height: 40,
                            displayValue: false, // El valor legible puede ir aparte
                            displayValue: false,
margin: 0
});
                    } catch (e) {
                        console.error("Error al generar código de barras", e);
                    }
                    } catch (e) { console.error("Error barcode", e); }
}
}, [barcodeValue]);
            
            const totalCajas = pkgInfo.cajas && pkgInfo.cajas > 0 ? pkgInfo.cajas : 1;

            // Fecha de entrega estimada
            const fechaEntrega = order.fechaEntrega || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('es-MX');

return (
                <div className="papeleta w-[200mm] h-[100mm] flex border border-black text-xs">
                    
                    {/* Sección 1: Datos de la Orden (70%) */}
                    <div className="w-[70%] border-r border-black p-2 flex flex-col justify-between">
                        
                        {/* Cabecera */}
                        <div>
                            <div className="flex justify-between items-center border-b border-black pb-1 mb-1">
                                <h1 className="text-xl font-bold">PAPELETA DE PRODUCCIÓN</h1>
                                <span className="text-sm font-bold bg-black text-white px-2 py-0.5 rounded">ID: {order.id}</span>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-x-4 gap-y-1 mb-2">
                                <div className="font-bold">Cliente: <span className="font-normal">{order.cliente}</span></div>
                                <div className="font-bold">No. Pedido: <span className="font-normal">{order.noPedido}</span></div>
                                <div className="font-bold">Modelo: <span className="font-normal">{order.modelo}</span></div>
                                <div className="font-bold">Color: <span className="font-normal">{order.color}</span></div>
                                <div className="font-bold">Fecha Pedido: <span className="font-normal">{formatTimestamp(order.fechaPedido)}</span></div>
                                <div className="font-bold">Fecha Entrega: <span className="font-normal">{formatTimestamp(order.fechaEntrega)}</span></div>
                            </div>
                <div className="label-preview-container">
                    {/* FILA 1: MODELO | TOTAL */}
                    <div className="lbl-row row-header">
                        <div className="lbl-col" style={{width: '60%'}}>
                            <div className="lbl-title">MODELO</div>
                            <div className="lbl-big">{order.codigo || 'S/N'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '40%'}}>
                            <div className="lbl-title">TOTAL PIEZAS ORDEN</div>
                            <div className="lbl-big">{order.totalPedido || 0}</div>
</div>
                    </div>

                        {/* Piezas del Paquete */}
                        <div className="flex-grow pt-2">
                            <h2 className="text-sm font-bold border-t border-black pt-1 mb-1">DETALLE DEL PAQUETE ({order.paqueteTipo})</h2>
                            <div className="grid grid-cols-5 gap-1 text-center font-bold text-sm border-b border-black">
                                <div className="col-span-2">TALLA</div>
                                <div className="col-span-3">CANTIDAD (Pzs)</div>
                            </div>
                            
                            <div className="max-h-[35mm] overflow-y-hidden">
                                {order.tallas && Object.entries(order.tallas).map(([talla, cantidad]) => (
                                    <div key={talla} className="grid grid-cols-5 gap-1 text-center py-0.5">
                                        <div className="col-span-2">{talla}</div>
                                        <div className="col-span-3 font-bold text-base">{cantidad}</div>
                                    </div>
                                ))}
                            </div>
                    {/* FILA 2: PARTIDA | CLIENTE */}
                    <div className="lbl-row row-info">
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">PARTIDA</div>
                            <div className="lbl-medium">{order.partida || '---'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">CLIENTE</div>
                            <div className="lbl-medium" style={{fontSize: order.cliente?.length > 10 ? '22px' : '26px'}}>{order.cliente || '---'}</div>
</div>
                    </div>

                        {/* Firma y Observaciones */}
                        <div className="border-t border-black pt-1 mt-2">
                            <div className="flex justify-between text-xs">
                                <div className="w-1/2 pr-2">
                                    <p className="font-bold">OBSERVACIONES:</p>
                                    <p className="border-b border-dashed border-black h-4"></p>
                                </div>
                                <div className="w-1/2 pl-2">
                                    <p className="font-bold">TEJEDOR (Nombre y Firma):</p>
                                    <p className="border-b border-dashed border-black h-4"></p>
                                </div>
                            </div>
                    {/* FILA 3: DESCRIPCION */}
                    <div className="lbl-row row-desc">
                        <div className="lbl-col" style={{flexDirection: 'row', alignItems: 'baseline', gap: '10px', width: '100%'}}>
                            <span className="lbl-title">DESCRIPCION:</span>
                            <span style={{fontSize: '16px', fontWeight: 'bold'}}>{subPiece.pieza || 'ESTANDAR'}</span>
</div>
</div>
                    
                    {/* Sección 2: Barcode y Resumen (30%) */}
                    <div className="w-[30%] p-2 flex flex-col justify-center items-center">
                        <div className="text-center mb-4">
                            <div className="text-3xl font-bold mb-1">Paquete: <span className="text-red-600">{pkgInfo.codigoUnico}</span></div>
                            <div className="text-xl font-bold">Caja <span className="text-red-600">{order.cajaIndex}</span> de <span className="text-red-600">{totalCajas}</span></div>

                    {/* FILA 4: METRICAS CENTRALES - AHORA MUESTRA PAQUETE ACTUAL Y PIEZAS EN ESTE PAQUETE */}
                    <div className="lbl-row row-metrics">
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PAQUETE<br/>ACTUAL</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{currentPackageDisplay}</div> {/* Muestra 1/N, 2/N, etc. */}
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', backgroundColor: '#e0e0e0', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PIEZAS EN<br/>PAQUETE</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{piecesInPackage}</div> {/* Piezas específicas en este paquete */}
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title">MAQUINA</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{order.maquina || '0'}</div>
</div>
                    </div>

                        {/* Código de Barras */}
                        <div className="flex flex-col items-center">
                            <svg ref={svgRef} className="w-full"></svg>
                            <span className="text-xs mt-1 font-mono">{barcodeValue}</span>
                    {/* FILA 5: MATERIALES Y DETALLES */}
                    <div className="lbl-row row-details">
                        {/* Izquierda: Hilos */}
                        <div style={{width: '50%', display: 'flex', flexDirection: 'column', borderRight: '2px solid black'}}>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', borderBottom: '1px solid black', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>NYLON</span>
                                <span className="lbl-small truncate" style={{fontSize: '14px'}} title={nylonText}>{nylonText.substring(0, 18)}</span>
                            </div>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>LYCRA</span>
                                <span className="lbl-small truncate" style={{fontSize: '14px'}} title={lycraText}>{lycraText.substring(0, 18)}</span>
                            </div>
</div>
                        
                        {/* QR Code o Espacio extra */}
                        <div className="mt-4 text-center">
                            <p className="font-bold text-sm">TOTAL PZS EN ESTE PAQUETE:</p>
                            <p className="text-4xl font-extrabold text-blue-600">{order.totalPzsPaquete}</p>
                        {/* Derecha: Grid de especificaciones */}
                        <div style={{width: '50%', display: 'grid', gridTemplateColumns: '1fr 1fr', gridTemplateRows: '1fr 1fr'}}>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', borderRight: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">TALLA</div>
                                <div className="lbl-medium" style={{fontSize: '20px'}}>{subPiece.talla || 'UNI'}</div>
                            </div>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">PESO (g)</div>
                                <div className="lbl-small">{subPiece.peso || '---'}</div>
                            </div>
                            <div className="lbl-col" style={{gridColumn: 'span 2', padding: '2px', flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div className="lbl-title">TIEMPO (min)</div>
                                <div className="lbl-small" style={{fontSize: '20px', marginRight: '10px'}}>{subPiece.tiempo || '---'}</div>
                            </div>
</div>
</div>

                    {/* FILA 6: FOOTER (FECHA Y BARCODE) */}
                    <div className="lbl-row row-footer" style={{padding: '0 10px', alignItems: 'center', justifyContent: 'space-between'}}>
                        <div style={{display: 'flex', flexDirection: 'column'}}>
                            <div className="lbl-title">FECHA DE ENTREGA</div>
                            <div className="lbl-medium" style={{fontSize: '20px'}}>{fechaEntrega}</div>
                        </div>
                        <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', flexGrow: 1}}>
                            <svg ref={svgRef}></svg>
                            <div style={{fontSize: '10px', marginTop: '-5px'}}>{barcodeValue}</div>
                        </div>
                    </div>
</div>
);
};
        
        // Función principal para generar los datos de la papeleta
        const generatePackageLabels = (selectedOrder) => {
            if (!selectedOrder || !selectedOrder.progreso) return [];
            
            const labels = [];
            
            // Si el progreso es un array, se genera una etiqueta por cada paquete/progreso
            selectedOrder.progreso.forEach((pkg, index) => {
                // Combina los datos de la orden con los datos específicos del paquete
                labels.push({
                    ...selectedOrder,
                    pkgId: pkg.id, // ID ÚNICO DEL PAQUETE
                    pkgInfo: pkg,
                    paqueteTipo: pkg.tipo || 'Mixto',
                    tallas: pkg.tallas,
                    totalPzsPaquete: pkg.totalPzs,
                    cajaIndex: index + 1 // Asume que el progreso está ordenado por caja
                });
            });

            return labels;
        };
        
        // Componente Principal de la Aplicación

        // --- APP PRINCIPAL ---
const App = () => {
const [orders, setOrders] = useState([]);
            const [selectedOrderId, setSelectedOrderId] = useState(null);
            const [selectedOrder, setSelectedOrder] = useState(null); // Orden completa seleccionada en la lista
            const [packageLabels, setPackageLabels] = useState([]); // Array de datos de papeletas (una por paquete)
const [loading, setLoading] = useState(true);
            const [filterText, setFilterText] = useState('');

            // Fetch de Órdenes desde Firebase
            // Función para generar los datos de las papeletas por paquete
            const generatePackageLabels = (order) => {
                const totalPieces = order.totalPedido || 0;
                // Usar 50 como fallback si no se define packageSize o es 'VARIO'
                const packageSizeValue = order.packageSize === 'VARIO' || !order.packageSize ? 50 : (Number(order.packageSize) || 50); 
                
                // Calcular N: número total de paquetes
                const N = totalPieces > 0 ? Math.ceil(totalPieces / packageSizeValue) : 1; 

                const labels = [];
                for (let i = 1; i <= N; i++) {
                    // Piezas en este paquete
                    const piecesInThisPackage = i < N ? packageSizeValue : (totalPieces % packageSizeValue || packageSizeValue);
                    
                    // Código de barras único: PARTIDA-CODIGO-PAQUETE_TOTAL (e.g., DIC25_02-M024-1_6)
                    const packageCode = `${order.partida}-${order.codigo}-${i}_${N}`;

                    labels.push({
                        ...order,
                        // Propiedades específicas del paquete
                        packageIndex: i, 
                        totalPackages: N, 
                        piecesInPackage: piecesInThisPackage,
                        packageCode: packageCode, 
                        displayPackageId: `${i}/${N}`, 
                    });
                }
                return labels;
            };

            // 1. Cargar órdenes activas
useEffect(() => {
const unsubscribe = db.collection('orders')
                    .where('status', 'in', ['PENDIENTE', 'EN PROCESO'])
                    .orderBy('fechaPedido', 'desc')
                    .where('status', '!=', 'ARCHIVADO')
.onSnapshot(snapshot => {
                        const fetchedOrders = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        const fetchedOrders = snapshot.docs.map(doc => doc.data());
                        fetchedOrders.sort((a, b) => b.id - a.id);
setOrders(fetchedOrders);
setLoading(false);
}, error => {
                        console.error("Error al obtener órdenes:", error);
                        console.error("Error fetching orders:", error);
setLoading(false);
});

                
return () => unsubscribe();
}, []);
            
            // 2. Generar papeletas al seleccionar una orden
            useEffect(() => {
                if (selectedOrder) {
                    setPackageLabels(generatePackageLabels(selectedOrder));
                } else {
                    setPackageLabels([]);
                }
            }, [selectedOrder]);


            // Orden seleccionada y generación de etiquetas
            const selectedOrder = useMemo(() => orders.find(o => o.id === selectedOrderId), [orders, selectedOrderId]);
            const packageLabels = useMemo(() => generatePackageLabels(selectedOrder), [selectedOrder]);
            // Filtrado
            const filteredOrders = useMemo(() => {
                if (!filterText) return orders;
                const txt = filterText.toUpperCase();
                return orders.filter(o => 
                    (o.codigo && o.codigo.includes(txt)) || 
                    (o.cliente && o.cliente.includes(txt)) ||
                    (o.partida && o.partida.includes(txt))
                );
            }, [orders, filterText]);

const handlePrint = () => {
                if(packageLabels.length === 0) return;
window.print();
};

            const handleArchive = async () => {
                if(!selectedOrder) return;
                
                // Reemplazando window.confirm con un modal simple (usando confirm por ahora, pero debe ser un componente)
                if(window.confirm(`¿Estás seguro de que ya imprimiste todas las ${packageLabels.length} papeletas para ${selectedOrder.codigo}?\n\nLa orden se marcará como ARCHIVADA y desaparecerá de esta lista.`)) {
                    try {
                        await db.collection('orders').doc(String(selectedOrder.id)).update({
                            status: 'ARCHIVADO',
                            printDate: new Date().toISOString()
                        });
                        setSelectedOrder(null); // Limpiar selección
                        // Usamos alert temporalmente
                        window.alert("Orden archivada correctamente.");
                    } catch (error) {
                        window.alert("Error al archivar: " + error.message);
                    }
                }
            };

return (
                <div className="flex h-screen overflow-hidden">
                <div className="flex h-screen w-full">

                    {/* Columna de Órdenes (Sidebar) */}
                    <div className="no-print w-80 bg-slate-800 text-white flex flex-col">
                        <div className="p-4 border-b border-slate-700">
                            <h2 className="text-xl font-bold flex items-center">
                                <Icon name="printer" size={20} className="mr-2" />
                                Generador de Papeletas
                            </h2>
                    {/* BARRA LATERAL (LISTA DE ÓRDENES) */}
                    <div className="w-96 bg-slate-800 text-white flex flex-col border-r border-slate-700 shadow-xl no-print z-10">
                        <div className="p-4 border-b border-slate-700 bg-slate-900">
                            <h1 className="text-xl font-bold flex items-center gap-2 text-yellow-400">
                                <Icon name="printer" /> GENERADOR PAPELETAS
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Selecciona una orden para generar sus papeletas.</p>
                            
                            <div className="mt-4 relative">
                                <input 
                                    type="text" 
                                    placeholder="Buscar modelo, cliente..." 
                                    value={filterText}
                                    onChange={e => setFilterText(e.target.value)}
                                    className="w-full bg-slate-800 border border-slate-600 rounded p-2 pl-8 text-sm focus:border-yellow-400 focus:outline-none"
                                />
                                <Icon name="search" size={14} className="absolute left-3 top-3 text-slate-500" />
                            </div>
</div>
                        
                        {/* Lista de Órdenes */}
                        <div className="flex-grow overflow-y-auto p-3">
                            {loading ? (
                                <div className="text-center py-10 text-slate-400">Cargando órdenes...</div>
                            ) : orders.length > 0 ? (
                                orders.map(order => (
                                    <div 
                                        key={order.id}
                                        className={`p-3 mb-2 rounded cursor-pointer transition-colors ${selectedOrderId === order.id ? 'bg-indigo-600 shadow-md' : 'bg-slate-700 hover:bg-slate-600'}`}
                                        onClick={() => setSelectedOrderId(order.id)}
                                    >
                                        <div className="font-bold text-sm">{order.cliente} - {order.modelo}</div>
                                        <div className="text-xs text-slate-300">Pedido: {order.noPedido} | ID: {order.id}</div>
                                        <div className="text-xs text-yellow-400 mt-1">{order.progreso ? order.progreso.length : 0} Paquetes</div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-10 text-slate-400">No hay órdenes pendientes.</div>

                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {loading && <div className="flex justify-center p-10"><div className="loader"></div></div>}
                            
                            {!loading && filteredOrders.length === 0 && (
                                <div className="text-center text-slate-500 p-8 text-sm">
                                    No hay órdenes activas encontradas.
                                </div>
)}

                            {filteredOrders.map(order => (
                                <div 
                                    key={order.id}
                                    onClick={() => setSelectedOrder(order)}
                                    className={`p-3 rounded cursor-pointer border-l-4 transition-all hover:bg-slate-700 ${selectedOrder?.id === order.id ? 'bg-slate-700 border-yellow-400 shadow-md' : 'bg-slate-800/50 border-transparent hover:border-slate-500'}`}
                                >
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-lg">{order.codigo}</span>
                                        <span className="bg-slate-900 text-xs px-2 py-0.5 rounded text-slate-300 font-mono">MQ-{order.maquina}</span>
                                    </div>
                                    <div className="text-sm text-slate-300 truncate">{order.cliente}</div>
                                    <div className="flex justify-between items-end mt-2">
                                        <span className="text-xs bg-yellow-900/30 text-yellow-200 px-1 rounded">{order.partida}</span>
                                        <span className="text-xs font-bold">{order.totalPedido} pzs</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="p-4 text-xs text-center text-slate-500 border-t border-slate-700 bg-slate-900">
                            Sistema Textil Cloud v2.1
</div>
</div>

                    {/* Contenido Principal (Visualización de Papeletas) */}
                    <div className="flex-grow flex flex-col">
                    {/* ÁREA PRINCIPAL (PREVISUALIZACIÓN) */}
                    <div className="flex-grow bg-slate-100 flex flex-col relative overflow-auto">

                        {/* Header con Botón de Imprimir */}
                        <div className="no-print p-4 bg-white border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-slate-800">Visualización de Papeletas</h1>
                            {packageLabels.length > 0 && (
                                <button
                                    onClick={handlePrint}
                                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200"
                                >
                                    <Icon name="printer" size={20} className="mr-2" />
                                    Imprimir {packageLabels.length} Papeleta(s)
                                </button>
                            )}
                        {/* HEADER DE ACCIONES (SOLO PANTALLA) */}
                        <div className="bg-white p-4 shadow-sm border-b flex justify-between items-center no-print sticky top-0 z-10">
                            <div>
                                {selectedOrder ? (
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                        VISTA PREVIA: <span className="text-black">{selectedOrder.codigo}</span>
                                        <span className="text-sm font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">{packageLabels.length} Papeletas generadas</span>
                                    </h2>
                                ) : (
                                    <h2 className="font-bold text-slate-400">Ninguna orden seleccionada</h2>
                                )}
                            </div>
                            <div className="flex gap-3">
                                {selectedOrder && (
                                    <>
                                        <button 
                                            onClick={handleArchive} 
                                            className="px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-300 transition flex items-center gap-2 text-sm"
                                            title="Mover a historial"
                                        >
                                            <Icon name="archive" size={16}/> ARCHIVAR ORDEN
                                        </button>
                                        <button 
                                            onClick={handlePrint} 
                                            className="px-6 py-2 bg-slate-900 text-white rounded font-bold hover:bg-slate-700 shadow-lg transition flex items-center gap-2"
                                        >
                                            <Icon name="printer" size={18}/> IMPRIMIR ({packageLabels.length})
                                        </button>
                                    </>
                                )}
                            </div>
</div>

                        {/* Área de Visualización (devuelve las etiquetas para la impresión) */}
                        {/* CONTENEDOR CENTRAL DE PAPELETAS (SCROLLABLE) */}
                        {/* Clase 'print-container' envuelve las etiquetas para la impresión */}
<div className="flex-grow flex flex-col items-center p-10 bg-slate-200 overflow-y-auto print-container">
{packageLabels.length > 0 ? (
packageLabels.map((labelData, index) => (
// wrapper div to control margin in screen and page-break in print
<div key={index} className="label-wrapper mb-8 p-4 bg-white rounded shadow-xl hover:shadow-2xl transition-shadow">
<ProductionLabel labelData={labelData} />
</div>
))
) : (
<div className="text-center text-slate-400 flex flex-col items-center mt-20">
<Icon name="arrow-left-circle" size={48} className="mb-4 opacity-50"/>
<p className="text-lg font-bold">Selecciona una orden del menú izquierdo</p>
<p className="text-sm">Para generar y visualizar sus papeletas.</p>
</div>
)}
</div>

</div>
</div>
);
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
