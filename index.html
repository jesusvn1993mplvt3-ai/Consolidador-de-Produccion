<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador de Producción - Certificación Manual</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos Generales */
        body { 
            background-color: #e2e8f0; /* slate-300 */
            min-height: 100vh;
            font-family: 'Roboto Condensed', sans-serif; 
        }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; 

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = ''; 
                    const svgString = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                    containerRef.current.innerHTML = svgString;
                }
            }, [name, size, className]);
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
        };

        // --- COMPONENTE PRINCIPAL DEL CONSOLIDADOR (MANUAL) ---
        const ConsolidatorManualChecker = () => {
            const [scanInput, setScanInput] = useState('');
            const [scanStatus, setScanStatus] = useState({ message: 'Ingrese el código de paquete y presione Certificar.', type: 'info' });
            const [lastScan, setLastScan] = useState(null);
            const [certifiedCount, setCertifiedCount] = useState(0); 
            const [isProcessing, setIsProcessing] = useState(false);
            const inputRef = useRef(null);
            
            // Función para procesar y certificar el código de barras
            const processCodeForCertification = async (e) => {
                e.preventDefault();
                
                const rawCode = scanInput.trim();
                if (!rawCode) return;

                const normalizedCode = rawCode.toUpperCase().replace(/'/g, '-').replace(/\?/g, '_');
                setScanStatus({ message: `Buscando código: ${normalizedCode}...`, type: 'info' });
                setIsProcessing(true);
                setScanInput(''); // Limpia el input para el siguiente escaneo
                
                try {
                    // 1. Buscar el registro de producción en la base de datos
                    const snapshot = await db.collection('registro_produccion')
                        .where('codigo_paquete', '==', normalizedCode)
                        .get();

                    if (snapshot.empty) {
                        setScanStatus({ message: `ERROR: Código ${normalizedCode} no encontrado en Producción.`, type: 'error' });
                        return;
                    }

                    const doc = snapshot.docs[0];
                    const docData = doc.data();

                    // 2. Verificar el estado actual del paquete
                    if (docData.status === 'CERTIFICADO') {
                        setScanStatus({ message: `ALERTA: Paquete ${normalizedCode} ya fue CERTIFICADO.`, type: 'warning' });
                        setLastScan({ ...docData, status: 'CERTIFICADO', fecha_certificacion: 'DUPLICADO' });
                        return;
                    }
                    
                    // 3. ¡CERTIFICAR EL PAQUETE! (ACTUALIZAR)
                    await db.collection('registro_produccion').doc(doc.id).update({
                        status: 'CERTIFICADO',
                        fecha_certificacion: FieldValue.serverTimestamp(),
                        certificador: 'Consolidador-Manual', 
                    });

                    // 4. Actualizar estado de la UI
                    setLastScan({ 
                        ...docData, 
                        status: 'CERTIFICADO', 
                        fecha_certificacion: new Date().toLocaleTimeString('es-MX') 
                    });
                    setCertifiedCount(prev => prev + 1);
                    setScanStatus({ message: `ÉXITO: Paquete ${normalizedCode} CERTIFICADO correctamente.`, type: 'success' });

                } catch (error) {
                    console.error("Error al certificar:", error);
                    setScanStatus({ message: `ERROR CRÍTICO: Falló la conexión/DB.`, type: 'error' });
                } finally {
                    setIsProcessing(false);
                    if (inputRef.current) inputRef.current.focus(); // Devuelve el foco al input
                }
            };

            const statusClasses = {
                info: 'bg-blue-100 text-blue-800 border-blue-300',
                success: 'bg-green-100 text-green-800 border-green-300',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-300',
                error: 'bg-red-100 text-red-800 border-red-300',
            };

            return (
                <div className="p-4 lg:p-10 w-full flex flex-col items-center">
                    <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden">
                        
                        {/* Header */}
                        <div className="p-5 bg-indigo-700 text-white flex justify-between items-center">
                            <h1 className="text-2xl font-bold flex items-center gap-3">
                                <Icon name="shield-check" size={28}/> CERTIFICACIÓN MANUAL
                            </h1>
                            <span className="text-lg font-mono bg-indigo-900 px-3 py-1 rounded">
                                Certificados Hoy: {certifiedCount}
                            </span>
                        </div>
                        
                        {/* Body */}
                        <div className="p-6">
                            
                            {/* FORMULARIO DE ENTRADA */}
                            <form onSubmit={processCodeForCertification} className="mb-6 space-y-4">
                                <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                                    <Icon name="tag" size={20}/> Código de Barras
                                </h2>
                                <input 
                                    ref={inputRef}
                                    type="text" 
                                    value={scanInput}
                                    onChange={e => setScanInput(e.target.value)}
                                    placeholder="Ingrese o pegue el código de paquete aquí"
                                    required
                                    className="w-full border-2 border-slate-300 rounded-lg p-3 text-center text-lg font-mono focus:border-indigo-500 focus:outline-none transition"
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    disabled={isProcessing || !scanInput.trim()}
                                    className={`w-full py-3 rounded-lg font-bold text-white transition shadow-lg flex items-center justify-center gap-3 text-lg ${isProcessing || !scanInput.trim() ? 'bg-indigo-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                                >
                                    {isProcessing ? (
                                        <>
                                            <div className="loader w-5 h-5 border-white"></div>
                                            Procesando...
                                        </>
                                    ) : (
                                        <>
                                            <Icon name="check-circle" size={22}/>
                                            CERTIFICAR PAQUETE
                                        </>
                                    )}
                                </button>
                                <div className={`p-3 rounded-lg text-sm font-medium border text-center ${statusClasses[scanStatus.type]}`}>
                                    {scanStatus.message}
                                </div>
                            </form>
                            
                            {/* Información del Último Escaneo */}
                            <div>
                                <h2 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <Icon name="package-check" size={20}/> Último Paquete Verificado
                                </h2>

                                <div className="p-4 bg-slate-50 border border-slate-200 rounded-lg shadow-inner">
                                    {lastScan ? (
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center pb-2 border-b border-slate-200">
                                                <span className="text-xs font-bold text-slate-500 uppercase">Código Paquete</span>
                                                <span className="text-lg font-mono font-extrabold text-indigo-700">{lastScan.codigo_paquete}</span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><span className="text-xs font-bold text-slate-500 block">Modelo / Partida</span><span className="font-bold text-slate-800">{lastScan.modelo} / {lastScan.partida}</span></div>
                                                <div><span className="text-xs font-bold text-slate-500 block">Pzs en Paquete</span><span className="font-bold text-slate-800">{lastScan.piezas_en_paquete}</span></div>
                                                <div><span className="text-xs font-bold text-slate-500 block">Tejedor(a)</span><span className="font-bold text-slate-800">{lastScan.tejedor || 'N/A'}</span></div>
                                                <div><span className="text-xs font-bold text-slate-500 block">Fecha Verif.</span><span className="font-bold text-slate-800 text-sm">{lastScan.fecha_certificacion || 'Pendiente'}</span></div>
                                            </div>

                                            <div className={`mt-3 p-3 rounded-lg text-center font-bold text-white shadow-md ${lastScan.status === 'CERTIFICADO' ? 'bg-green-600' : 'bg-red-600'}`}>
                                                ESTADO: {lastScan.status || 'PRODUCCIÓN'}
                                            </div>

                                        </div>
                                    ) : (
                                        <p className="text-center text-slate-500 italic p-6">
                                            Verifique el primer paquete para ver su información aquí.
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ConsolidatorManualChecker />);
    </script>
</body>
</html>
